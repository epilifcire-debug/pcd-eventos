<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Sistema PCD ‚Äî Eventos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- jsPDF para gerar PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --bg: #f5f5f5;
      --card: #ffffff;
      --text: #222;
      --border: #dddddd;
      --accent1: #8338ec;
      --accent2: #ff006e;
      --accent3: #ffbe0b;
      --btn-text: #ffffff;
      --shadow: rgba(0,0,0,0.08);
    }

    body.dark {
      --bg: #222222;
      --card: #333333;
      --text: #f1f1f1;
      --border: #555555;
      --shadow: rgba(0,0,0,0.55);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s ease, color 0.3s ease;
    }

    header {
      background: linear-gradient(90deg, var(--accent1), var(--accent2), var(--accent3));
      color: white;
      text-align: center;
      padding: 16px 8px 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .logos-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 40px;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }

    .logo {
      width: 180px;
      height: 180px;
      object-fit: contain;
      transition: transform .3s ease;
    }
    .logo:hover { transform: scale(1.05); }

    header h1 {
      margin: 0;
      font-size: 22px;
    }

    main {
      max-width: 1100px;
      margin: 20px auto 40px;
      padding: 0 10px;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
      box-shadow: 0 4px 14px var(--shadow);
      border: 1px solid var(--border);
      transition: background 0.3s ease, border-color 0.3s ease, color 0.3s ease;
    }

    .hidden { display: none; }

    .nav-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
      justify-content: center;
    }

    .nav-buttons button {
      border: none;
      border-radius: 8px;
      padding: 8px 14px;
      background: linear-gradient(90deg, var(--accent1), var(--accent2), var(--accent3));
      color: var(--btn-text);
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: transform .15s ease, box-shadow .15s ease, opacity .2s ease;
    }

    .nav-buttons button:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.25);
      opacity: 0.95;
    }

    .nav-buttons button.active {
      box-shadow: 0 0 0 2px rgba(255,255,255,0.7);
    }

    .top-controls {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    button.primary {
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      background: linear-gradient(90deg, var(--accent1), var(--accent2), var(--accent3));
      color: var(--btn-text);
      font-weight: 600;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      transition: transform .15s ease, box-shadow .15s ease, opacity .2s ease;
    }
    button.primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 10px rgba(0,0,0,0.3);
      opacity: 0.95;
    }

    button.ghost {
      border-radius: 8px;
      border: 1px solid var(--border);
      background: transparent;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text);
      transition: background .15s ease, color .15s ease, transform .1s ease;
    }
    button.ghost:hover {
      background: rgba(0,0,0,0.05);
      transform: translateY(-1px);
    }

    #btn-theme {
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      font-size: 18px;
    }

    label {
      display: block;
      margin-top: 8px;
      font-size: 14px;
      font-weight: 600;
    }

    input, textarea, select {
      width: 100%;
      margin-top: 4px;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 14px;
      background: transparent;
      color: var(--text);
      transition: border-color .2s ease, background .2s ease, color .2s ease;
    }

    textarea { resize: vertical; }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--accent1);
      box-shadow: 0 0 0 1px rgba(131,56,236,0.3);
      background: rgba(255,255,255,0.03);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 14px;
    }

    th, td {
      border-bottom: 1px solid rgba(220,220,220,0.6);
      padding: 6px 4px;
      text-align: left;
      vertical-align: top;
    }

    body.dark th, body.dark td {
      border-bottom-color: #444;
    }

    th { font-weight: 600; }

    .msg {
      padding: 6px 10px;
      border-radius: 8px;
      display: inline-block;
      margin-top: 8px;
      font-size: 13px;
    }
    .msg.ok   { background:#e5ffe9; color:#0b7a29; }
    .msg.err  { background:#ffe5e5; color:#b01818; }

    .docs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 8px;
      margin-top: 10px;
    }
    .docs-grid label { font-weight: 500; }

    .docs-grid input[type="file"] {
      margin-top: 4px;
      padding: 3px;
      font-size: 13px;
    }

    .status-bolinha {
      display: inline-block;
      width: 10px;
      height: 10px;
      margin-left: 6px;
      border-radius: 50%;
      box-shadow: 0 0 6px rgba(0,0,0,0.4);
    }
    .status-ok       { background:#1dd85f; box-shadow:0 0 10px rgba(29,216,95,0.9); }
    .status-pendente { background:#ff3b3b; box-shadow:0 0 10px rgba(255,59,59,0.9); }

    #tel-msg {
      font-size: 12px;
      color: #c77d00;
      display: none;
      margin-top: 4px;
    }

    footer {
      text-align: center;
      font-size: 12px;
      color: #aaa;
      margin-top: 20px;
    }

    /* Admin list */
    #admin-users {
      max-height: 240px;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 8px;
      font-size: 13px;
    }
    .admin-user-item {
      padding: 6px 4px;
      border-bottom: 1px solid rgba(220,220,220,0.5);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    body.dark .admin-user-item {
      border-bottom-color: #444;
    }

    .admin-user-meta {
      flex: 1;
      min-width: 180px;
    }

    @media (max-width: 600px) {
      header h1 { font-size: 18px; }
      .logo { width: 140px; height: 140px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="logos-container">
      <img src="Logo-do-Pre-Caju-1.png" alt="Logo Pr√©-Caju" class="logo">
      <img src="images.png" alt="Logo Point do Ingresso" class="logo">
    </div>
    <h1>Sistema PCD ‚Äî Eventos</h1>
  </header>

  <main>
    <!-- Controles topo (s√≥ quando logado) -->
    <div id="top-controls" class="top-controls hidden">
      <button id="btn-theme" class="ghost" title="Alternar tema">üåô</button>
      <button id="btn-admin" class="ghost" title="Administra√ß√£o do sistema">Admin</button>
      <button id="btn-logout" class="ghost" title="Sair do sistema">Sair</button>
    </div>

    <!-- TELA DE LOGIN -->
    <section id="login-screen" class="card">
      <h2 style="text-align:center;">Acesso ao Sistema</h2>
      <label>Usu√°rio</label>
      <input id="login-user" autocomplete="username">

      <label>Senha</label>
      <input id="login-pass" type="password" autocomplete="current-password">

      <div style="margin-top:12px; display:flex; gap:8px; justify-content:center;">
        <button id="btn-login" class="primary" style="min-width:120px;">Entrar</button>
      </div>

      <div id="login-msg" class="msg hidden"></div>
    </section>

    <!-- APLICA√á√ÉO PRINCIPAL -->
    <div id="app" class="hidden">
      <section class="card">
        <div class="nav-buttons">
          <button data-target="card-eventos" class="active">Eventos</button>
          <button data-target="card-pessoas">Pessoas</button>
          <button data-target="card-relatorios">Relat√≥rios</button>
        </div>
      </section>

      <!-- CARD EVENTOS -->
      <section id="card-eventos" class="card">
        <h2>Cadastro de Eventos</h2>

        <label>Nome do Evento</label>
        <input id="ev-nome">

        <label>Data do Evento</label>
        <input id="ev-data" type="date">

        <label>Descri√ß√£o</label>
        <textarea id="ev-desc" rows="2"></textarea>

        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
          <button id="ev-salvar" class="primary">Salvar Evento</button>
          <button id="ev-limpar" class="ghost">Limpar</button>
        </div>

        <div id="ev-msg" class="msg hidden"></div>

        <h3 style="margin-top:16px;">Eventos Cadastrados</h3>
        <table>
          <thead>
          <tr>
            <th>Data</th>
            <th>Nome</th>
            <th>Descri√ß√£o</th>
            <th>A√ß√µes</th>
          </tr>
          </thead>
          <tbody id="tab-eventos"></tbody>
        </table>
      </section>

      <!-- CARD PESSOAS -->
      <section id="card-pessoas" class="card hidden">
        <h2>Cadastro de Pessoas</h2>

        <label>Buscar</label>
        <input id="p-busca" placeholder="Buscar por nome ou CPF">

        <label style="margin-top:8px;">Nome</label>
        <input id="p-nome">

        <label>CPF</label>
        <input id="p-cpf" maxlength="14" placeholder="Somente n√∫meros">

        <label>Telefone
          <span title="Formato: (DD) 99999-9999 ‚Äî opcional" style="cursor:help;">‚ÑπÔ∏è</span>
        </label>
        <input id="p-tel" placeholder="(79) 99999-9999">
        <div id="tel-msg"></div>

        <label>Descri√ß√£o</label>
        <textarea id="p-desc" rows="2"></textarea>

        <label>Evento(s) ‚Äî segure Ctrl/Cmd para selecionar m√∫ltiplos</label>
        <select id="p-eventos" multiple size="4"></select>

        <!-- DOCUMENTOS -->
        <h3 style="margin-top:14px;">üì∏ Documentos da Pessoa (opcionais)</h3>
        <div class="docs-grid">
          <label>Requerimento (opcional)
            <input type="file" id="doc-requerimento" accept=".pdf,image/jpeg,image/jpg,image/png">
          </label>
          <label>Foto (opcional)
            <input type="file" id="doc-foto" accept=".pdf,image/jpeg,image/jpg,image/png">
          </label>
          <label>Documento oficial com foto (opcional)
            <input type="file" id="doc-docoficial" accept=".pdf,image/jpeg,image/jpg,image/png">
          </label>
          <label>Laudo m√©dico (opcional)
            <input type="file" id="doc-laudo" accept=".pdf,image/jpeg,image/jpg,image/png">
          </label>
          <label>Cad √önico (opcional)
            <input type="file" id="doc-cadunico" accept=".pdf,image/jpeg,image/jpg,image/png">
          </label>
          <label>Cart√£o BPC (opcional)
            <input type="file" id="doc-bpc" accept=".pdf,image/jpeg,image/jpg,image/png">
          </label>
          <label>Comprovante de resid√™ncia (opcional)
            <input type="file" id="doc-comprovante" accept=".pdf,image/jpeg,image/jpg,image/png">
          </label>
        </div>

        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
          <button id="p-salvar" class="primary">Salvar Pessoa</button>
          <button id="p-limpar" class="ghost">Limpar</button>
          <button id="p-enviar-docs" class="primary">üì∏ Enviar Documentos</button>
          <button id="p-ver-docs" class="ghost">üëÅÔ∏è Visualizar Documentos</button>
        </div>

        <div id="p-msg" class="msg hidden"></div>

        <h3 style="margin-top:16px;">Pessoas Cadastradas</h3>
        <table>
          <thead>
          <tr>
            <th>Nome</th>
            <th>CPF</th>
            <th>Evento(s)</th>
            <th>A√ß√µes</th>
          </tr>
          </thead>
          <tbody id="tab-pessoas"></tbody>
        </table>
      </section>

      <!-- CARD RELAT√ìRIOS -->
      <section id="card-relatorios" class="card hidden">
        <h2>Relat√≥rios</h2>

        <label>Evento</label>
        <select id="r-evento"></select>

        <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:8px;">
          <button id="r-filtrar" class="ghost">Filtrar</button>
          <button id="r-pdf" class="ghost">Exportar PDF</button>
          <button id="r-print" class="ghost">Visualizar Impress√£o</button>
          <button id="r-backup" class="primary">‚¨áÔ∏è Exportar Backup</button>
          <button id="r-restore" class="ghost">‚¨ÜÔ∏è Importar Backup</button>
          <input type="file" id="r-backup-file" accept=".json" style="display:none;">
        </div>

        <div id="r-msg" class="msg hidden"></div>
      </section>

      <!-- CARD ADMIN -->
      <section id="card-admin" class="card hidden">
        <h2>Administra√ß√£o de Usu√°rios</h2>
        <p style="font-size:13px; opacity:0.8;">Apenas usu√°rios com perfil <strong>Administrador</strong> podem acessar este painel.</p>

        <h3>Novo / Editar Usu√°rio</h3>
        <label>Usu√°rio (login)</label>
        <input id="a-user" placeholder="ex: joao">

        <label>Senha</label>
        <input id="a-pass" type="password" placeholder="defina uma senha">

        <label>Nome Completo</label>
        <input id="a-nome" placeholder="Nome vis√≠vel no sistema">

        <label>Tipo de Usu√°rio</label>
        <select id="a-role">
          <option value="admin">Administrador</option>
          <option value="user">Padr√£o</option>
        </select>

        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
          <button id="a-salvar" class="primary">Salvar Usu√°rio</button>
          <button id="a-limpar" class="ghost">Limpar</button>
        </div>

        <h3 style="margin-top:16px;">Usu√°rios Cadastrados</h3>
        <div id="admin-users"></div>
      </section>

      <footer>
        Sistema PCD Local ‚Äî Dados em navegador + documentos no servidor Node.js
      </footer>
    </div>
  </main>

  <!-- ===================================================== -->
  <!-- SCRIPT PRINCIPAL                                      -->
  <!-- ===================================================== -->
  <script>
    // ===================== DADOS EM LOCALSTORAGE =====================
    let eventos  = JSON.parse(localStorage.getItem("eventos")  || "[]");
    let pessoas  = JSON.parse(localStorage.getItem("pessoas")  || "[]");
    let usuarios = JSON.parse(localStorage.getItem("usuarios") || "[]");
    let usuarioAtual = null;

    // garante campo data em eventos
    eventos = eventos.map(e => ({ ...e, data: e.data || "" }));

    const DEFAULT_USERS = [
      { user:"admin", pass:"1234", nome:"Administrador", role:"admin" }
    ];
    if (usuarios.length === 0) {
      usuarios = DEFAULT_USERS;
      localStorage.setItem("usuarios", JSON.stringify(usuarios));
    }

    // üîπ BACKEND LOCAL x ONLINE (Render)
    const servidor = window.location.hostname.includes("localhost")
      ? "http://localhost:3000"
      : "https://pcd-eventos.onrender.com";

    async function backupOnline() {
      try {
        const backup = { eventos, pessoas, usuarios };
        await fetch(servidor + "/backup-json", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(backup),
        });
        console.log("üíæ Backup online enviado com sucesso");
      } catch (err) {
        console.error("Erro ao enviar backup online:", err);
      }
    }

    function salvarTudo() {
      localStorage.setItem("eventos",  JSON.stringify(eventos));
      localStorage.setItem("pessoas",  JSON.stringify(pessoas));
      localStorage.setItem("usuarios", JSON.stringify(usuarios));
      
}

/* =====================================================
   üîÅ BACKUP AUTOM√ÅTICO + SINCRONIZA√á√ÉO CLOUDINARY
   ===================================================== */

let ultimoBackupCloudinaryId = localStorage.getItem("ultimoBackupCloudinaryId") || null;

async function backupOnline() {
  try {
    const backup = { eventos, pessoas, usuarios };
    const resp = await fetch(servidor + "/backup-json", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(backup),
    });
    if (!resp.ok) throw new Error("Erro ao enviar backup");
    const data = await resp.json();
    console.log("‚òÅÔ∏è Backup online salvo:", data.url || "(sem URL)");
  } catch (err) {
    console.error("‚ùå Erro ao enviar backup online:", err);
  }
}

function backupAutomatico() {
  try {
    localStorage.setItem("backupAuto", JSON.stringify({
      eventos, pessoas, usuarios, ts: Date.now(),
    }));
    backupOnline();
    console.log("üíæ Backup autom√°tico realizado:", new Date().toLocaleTimeString());
  } catch (err) {
    console.error("‚ùå Falha ao realizar backup autom√°tico:", err);
  }
}

setInterval(backupAutomatico, 30000);
window.addEventListener("beforeunload", backupAutomatico);

/* =====================================================
   üîÑ SINCRONIZA√á√ÉO AUTOM√ÅTICA COM CLOUDINARY
   ===================================================== */
async function carregarBackupCloudinary() {
  try {
    const res = await fetch(servidor + "/listar-backups");
    if (!res.ok) {
      console.warn("N√£o foi poss√≠vel obter lista de backups do servidor.");
      return;
    }

    const data = await res.json();
    if (!data.url || !data.public_id) {
      console.warn("Nenhum backup dispon√≠vel no Cloudinary.");
      return;
    }

    if (ultimoBackupCloudinaryId && ultimoBackupCloudinaryId === data.public_id) {
      console.log("üîÅ Backup remoto igual ao local, nada a atualizar.");
      return;
    }

    console.log("üîΩ Novo backup detectado! Baixando:", data.url);
    const backupRes = await fetch(data.url);
    const backupJson = await backupRes.json();

    if (!backupJson.eventos || !backupJson.pessoas || !backupJson.usuarios) {
      console.warn("Backup baixado n√£o cont√©m estrutura v√°lida.");
      return;
    }

    eventos  = (backupJson.eventos || []).map(e => ({ ...e, data: e.data || "" }));
    pessoas  = backupJson.pessoas || [];
    usuarios = backupJson.usuarios || [];

    localStorage.setItem("eventos",  JSON.stringify(eventos));
    localStorage.setItem("pessoas",  JSON.stringify(pessoas));
    localStorage.setItem("usuarios", JSON.stringify(usuarios));

    ultimoBackupCloudinaryId = data.public_id;
    localStorage.setItem("ultimoBackupCloudinaryId", ultimoBackupCloudinaryId);

    console.log("‚úÖ Dados atualizados automaticamente do Cloudinary.");
    atualizarInterface();
  } catch (err) {
    console.error("‚ùå Erro ao carregar backup autom√°tico:", err);
  }
}

setTimeout(carregarBackupCloudinary, 3000);
setInterval(carregarBackupCloudinary, 30000);


    // ===================== INICIALIZA√á√ÉO =====================
    atualizarInterface();
  </script>
</body>
</html>
