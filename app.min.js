const API_BASE = window.location.hostname.includes("localhost") || window.location.hostname.includes("127.0.0.1")
  ? "http://localhost:3000"
  : "https://pcd-eventos.onrender.com";

window.addEventListener("error", e => console.error("Erro global:", e.message));
window.addEventListener("unhandledrejection", e => console.error("Erro n√£o tratado:", e.reason));

const loginScreen = document.getElementById("login-screen"),
  appSection = document.getElementById("app"),
  loginEmail = document.getElementById("login-email"),
  loginPass = document.getElementById("login-pass"),
  loginMsg = document.getElementById("login-msg"),
  btnLogin = document.getElementById("btn-login"),
  btnLogout = document.getElementById("btn-logout"),
  navAdmin = document.getElementById("nav-admin");

let token = null, userData = null;

async function apiRequest(url, options = {}) {
  if (!options.headers) options.headers = {};
  if (token) options.headers["Authorization"] = "Bearer " + token;

  try {
    const res = await fetch(API_BASE + url, options);
    if (!res.ok) {
      const errText = await res.text();
      throw new Error(errText || res.statusText);
    }
    return await res.json();
  } catch (err) {
    console.error("Erro de rede:", err);
    throw new Error("Falha ao se comunicar com o servidor: " + err.message);
  }
}

function showSection(id) {
  document.querySelectorAll("main section.card").forEach(s => s.classList.add("hidden"));
  const target = document.getElementById(id);
  if (target) target.classList.remove("hidden");
}

async function handleLogin() {
  const email = loginEmail.value.trim(), senha = loginPass.value.trim();
  if (!email || !senha) {
    loginMsg.style.display = "block";
    loginMsg.textContent = "Preencha e-mail e senha.";
    return;
  }
  try {
    const res = await fetch(API_BASE + "/api/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, senha })
    });
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    token = data.token;
    userData = data.user;
    localStorage.setItem("token", token);
    localStorage.setItem("user", JSON.stringify(userData));
    loginScreen.classList.add("hidden");
    appSection.classList.remove("hidden");
    if (userData.role === "admin") navAdmin.classList.remove("hidden");
    loadEventos();
  } catch (err) {
    loginMsg.style.display = "block";
    if (err.message.includes("Failed to fetch")) {
      loginMsg.textContent = "N√£o foi poss√≠vel conectar ao servidor. Verifique se o backend est√° online em https://pcd-eventos.onrender.com";
    } else {
      loginMsg.textContent = "Erro: " + err.message;
    }
  }
}

async function loadEventos() {
  const card = document.getElementById("card-eventos");
  card.innerHTML = "<h2>Eventos</h2><p>Carregando...</p>";
  try {
    const eventos = await apiRequest("/api/eventos");
    if (!eventos.length) {
      card.innerHTML = "<h2>Eventos</h2><p>Nenhum evento cadastrado.</p>";
      return;
    }
    let html = "<h2>Eventos</h2><table><thead><tr><th>Nome</th><th>Data</th><th>Descri√ß√£o</th></tr></thead><tbody>";
    for (const ev of eventos) {
      html += `<tr><td>${ev.nome}</td><td>${ev.data || "-"}</td><td>${ev.descricao || "-"}</td></tr>`;
    }
    html += "</tbody></table>";
    card.innerHTML = html;
  } catch (e) {
    card.innerHTML = "<h2>Eventos</h2><p>Erro ao carregar eventos: " + e.message + "</p>";
  }
}

function logout() {
  localStorage.removeItem("token");
  localStorage.removeItem("user");
  token = null;
  userData = null;
  appSection.classList.add("hidden");
  loginScreen.classList.remove("hidden");
}

btnLogin.addEventListener("click", handleLogin);
btnLogout.addEventListener("click", logout);

document.querySelectorAll(".nav button[data-target]").forEach(b => {
  b.addEventListener("click", () => showSection(b.dataset.target));
});

const savedToken = localStorage.getItem("token"), savedUser = localStorage.getItem("user");
if (savedToken && savedUser) {
  token = savedToken;
  userData = JSON.parse(savedUser);
  loginScreen.classList.add("hidden");
  appSection.classList.remove("hidden");
  if (userData.role === "admin") navAdmin.classList.remove("hidden");
  loadEventos();
}

// Tema claro/escuro
const toggle = document.getElementById("toggle-theme");
if (toggle) {
  toggle.addEventListener("click", () => {
    document.body.classList.toggle("dark");
    toggle.textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è" : "üåô";
  });
}
